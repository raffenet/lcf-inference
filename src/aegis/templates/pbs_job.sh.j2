#!/bin/bash
#PBS -N aegis
#PBS -l walltime={{ config.walltime }}
#PBS -l select={{ config.nodes_needed }}
#PBS -l filesystems={{ config.filesystems }}
#PBS -A {{ config.account }}
{% if config.queue -%}
#PBS -q {{ config.queue }}
{% endif -%}
#PBS -o aegis_output.log
#PBS -j oe

cd "$PBS_O_WORKDIR"

{% if config.aegis_env %}
module load miniforge3
eval "$(conda shell.bash hook)"
conda activate {{ config.aegis_env }}
{% endif %}
export TMPDIR=/tmp

if ! command -v aegis &>/dev/null; then
    echo "Error: 'aegis' command not found in the job environment." >&2
    echo "Add 'aegis_env: /path/to/conda/env' to your config YAML to specify a conda environment containing aegis." >&2
    exit 1
fi

export HTTP_PROXY=http://proxy.alcf.anl.gov:3128
export HTTPS_PROXY=http://proxy.alcf.anl.gov:3128
export http_proxy=http://proxy.alcf.anl.gov:3128
export https_proxy=http://proxy.alcf.anl.gov:3128
export no_proxy=localhost,127.0.0.1

NNODES=$(cat $PBS_NODEFILE | uniq | wc -l)

if [ -z "${HF_TOKEN:-}" ]; then
    echo "Warning: HF_TOKEN not set. Gated models will fail to load." >&2
fi

{% if config.conda_env %}
# --- STAGE CONDA ENV ---
TOOLS_DIR="${PBS_O_WORKDIR}/tools"
BCAST_BIN="${PBS_O_WORKDIR}/bcast"

pushd $TOOLS_DIR
make bcast
cp bcast $BCAST_BIN
popd

export MPIR_CVAR_CH4_OFI_ENABLE_MULTI_NIC_STRIPING=1
export MPIR_CVAR_CH4_OFI_MAX_NICS=4

echo "Staging conda env {{ config.conda_env }} to /tmp..."
mpiexec -ppn 1 --cpu-bind numa $BCAST_BIN "{{ config.conda_env }}" "/tmp"
{% endif %}

{% set has_model_source = config.models | selectattr('model_source') | list | length > 0 %}
{% if has_model_source %}
# --- STAGE MODEL WEIGHTS ---
TOOLS_DIR="${PBS_O_WORKDIR}/tools"
BCAST_BIN="${PBS_O_WORKDIR}/bcast"

pushd $TOOLS_DIR
make bcast
cp bcast $BCAST_BIN
popd

export MPIR_CVAR_CH4_OFI_ENABLE_MULTI_NIC_STRIPING=1
export MPIR_CVAR_CH4_OFI_MAX_NICS=4

{% for m in config.models %}
{% if m.model_source %}
echo "Staging weights from {{ m.model_source }} to {{ config.hf_home }}/hub..."
mpiexec -ppn 1 --cpu-bind numa $BCAST_BIN "{{ m.model_source }}" "{{ config.hf_home }}/hub"
{% endif %}
{% endfor %}
{% endif %}

# --- WRITE CONFIG AND LAUNCH INSTANCES ---
cat > ${PBS_O_WORKDIR}/.aegis_config.yaml << 'AEGIS_CONFIG_EOF'
{{ config_yaml }}AEGIS_CONFIG_EOF

aegis launch --config ${PBS_O_WORKDIR}/.aegis_config.yaml

{% if config.bench %}
echo "Running benchmark..."
bench_args=(
    --model {{ config.models[0].model }}
    --num-prompts {{ config.bench_num_prompts }}
    --endpoints-file {{ config.endpoints_file }}
{% if config.conda_env %}
    --conda-env /tmp/conda_env
{% endif %}
)
aegis bench "${bench_args[@]}"
echo "Benchmark complete. Exiting."
{% else %}
# Keep the job alive so vLLM servers remain running until walltime expires.
echo "Instances launched. Sleeping until walltime expires..."
sleep infinity
{% endif %}
