#!/bin/bash
#PBS -N aegis
#PBS -l walltime={{ config.walltime }}
#PBS -l select={{ config.nodes_needed }}
#PBS -l filesystems={{ config.filesystems }}
#PBS -A {{ config.account }}
{% if config.queue -%}
#PBS -q {{ config.queue }}
{% endif -%}
#PBS -j oe

cd "$PBS_O_WORKDIR"

{% if config.aegis_env %}
module load miniforge3
eval "$(conda shell.bash hook)"
conda activate {{ config.aegis_env }}
{% endif %}
export TMPDIR=/tmp

if ! command -v aegis &>/dev/null; then
    echo "Error: 'aegis' command not found in the job environment." >&2
    echo "Add 'aegis_env: /path/to/conda/env' to your config YAML to specify a conda environment containing aegis." >&2
    exit 1
fi

export HTTP_PROXY=http://proxy.alcf.anl.gov:3128
export HTTPS_PROXY=http://proxy.alcf.anl.gov:3128
export http_proxy=http://proxy.alcf.anl.gov:3128
export https_proxy=http://proxy.alcf.anl.gov:3128
export no_proxy=localhost,127.0.0.1

NNODES=$(cat $PBS_NODEFILE | uniq | wc -l)

if [ -z "${HF_TOKEN:-}" ]; then
    echo "Warning: HF_TOKEN not set. Gated models will fail to load." >&2
fi

# --- WRITE CONFIG AND LAUNCH INSTANCES ---
cat > ${PBS_O_WORKDIR}/.aegis_config.yaml << 'AEGIS_CONFIG_EOF'
{{ config_yaml }}AEGIS_CONFIG_EOF

aegis launch --config ${PBS_O_WORKDIR}/.aegis_config.yaml

{% if config.bench %}
echo "Running benchmark..."
bench_args=(
    --model {{ config.models[0].model }}
    --num-prompts {{ config.bench_num_prompts }}
    --endpoints-file {{ config.endpoints_file }}
{% if config.conda_env %}
    --conda-env /tmp/conda_env
{% endif %}
)
aegis bench "${bench_args[@]}"
echo "Benchmark complete. Exiting."
{% else %}
# Keep the job alive so vLLM servers remain running until walltime expires.
echo "Instances launched. Sleeping until walltime expires..."
sleep infinity
{% endif %}
